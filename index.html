<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WhatsApp Bot Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>

  <body
    class="bg-gradient-to-br from-slate-950 via-slate-900 to-black text-slate-100 min-h-screen"
  >
    <div class="flex min-h-screen">
      <aside
        class="w-64 bg-slate-950 shadow-xl border-r border-slate-800 flex flex-col"
      >
        <div class="p-6 border-b border-slate-800">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 bg-gradient-to-br from-green-400 to-green-600 rounded-xl flex items-center justify-center text-white text-xl"
            >
              ðŸ“±
            </div>
            <div>
              <h1 class="text-lg font-bold text-slate-100">WhatsApp Bot</h1>
              <p class="text-xs text-slate-400">Advanced Dashboard</p>
            </div>
          </div>
        </div>

        <nav id="sidebar-tabs" class="flex-1 p-4 space-y-2">
          <button
            type="button"
            data-tab="dashboard"
            class="tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium transition-all bg-emerald-700 text-emerald-100 border border-emerald-500"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
              />
            </svg>
            Dashboard
          </button>
          <button
            type="button"
            data-tab="whatsapp"
            class="tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium transition-all bg-transparent text-slate-300 hover:bg-slate-900 border border-transparent"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
              />
            </svg>
            WhatsApp Message
          </button>
          <button
            type="button"
            data-tab="ai"
            class="tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left font-medium transition-all bg-transparent text-slate-300 hover:bg-slate-900 border border-transparent"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"
              />
            </svg>
            AI Generative
          </button>
        </nav>
      </aside>

      <main class="flex-1 overflow-y-auto">
        <header class="bg-slate-950 border-b border-slate-800 px-8 py-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div
                class="w-10 h-10 bg-emerald-800/40 rounded-full flex items-center justify-center"
              >
                <svg
                  class="w-6 h-6 text-emerald-400"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"
                  />
                </svg>
              </div>
              <span class="text-lg font-semibold text-slate-100">WhatsApp</span>
            </div>
            <button
              id="connectBtn"
              class="bg-emerald-600 hover:bg-emerald-500 text-white font-medium px-6 py-2 rounded-lg transition flex items-center gap-2"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M13 10V3L4 14h7v7l9-11h-7z"
                />
              </svg>
              Connect WhatsApp
            </button>
          </div>
        </header>

        <div class="p-8">
          <section id="section-dashboard" class="tab-section">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-slate-100 mb-2">Dashboard</h2>
              <p class="text-slate-400">
                Monitor and filter your WhatsApp messages
              </p>
            </div>

            <div
              class="bg-slate-950 rounded-xl shadow-sm border border-slate-800 p-6 mb-6"
            >
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <input
                  id="filter-sender"
                  type="text"
                  placeholder="Filter by Sender No"
                  class="px-4 py-2 border border-slate-700 bg-slate-900 text-slate-100 placeholder-slate-400 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none"
                />
                <input
                  id="filter-message"
                  type="text"
                  placeholder="Filter by Message"
                  class="px-4 py-2 border border-slate-700 bg-slate-900 text-slate-100 placeholder-slate-400 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none"
                />
                <input
                  id="filter-media"
                  type="text"
                  placeholder="Filter by Media"
                  class="px-4 py-2 border border-slate-700 bg-slate-900 text-slate-100 placeholder-slate-400 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none"
                />
                <input
                  id="filter-delivered-at"
                  type="date"
                  placeholder="Filter by Delivered At"
                  class="px-4 py-2 border border-slate-700 bg-slate-900 text-slate-100 placeholder-slate-400 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none"
                />
                <button
                  id="filter-btn"
                  type="button"
                  class="bg-emerald-600 hover:bg-emerald-500 text-white font-medium px-6 py-2 rounded-lg transition"
                >
                  Apply Filter
                </button>
                <button
                  id="clear-filter-btn"
                  type="button"
                  class="bg-slate-700 text-white font-medium px-6 py-2 rounded-lg transition ml-2 opacity-50 cursor-not-allowed"
                  disabled
                >
                  Clear Filter
                </button>
              </div>
            </div>

            <div class="bg-slate-950 rounded-xl shadow-sm border border-slate-800 overflow-hidden">
              <div class="overflow-x-auto overflow-y-hidden">
                <table class="min-w-full divide-y divide-slate-800">
                  <thead class="bg-slate-900  overflow-hidden">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">ID</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Sender(s)</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Message</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Recipient</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Media</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Delivered At</th>
                    </tr>
                  </thead>
                  <tbody id="dashboard-table-body" class="bg-slate-950 divide-y divide-slate-800"></tbody>
                </table>
              </div>
            </div>
          </section>

          <section id="section-whatsapp" class="tab-section hidden">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-slate-100 mb-2">
                Send WhatsApp Messages
              </h2>
              <p class="text-slate-400">
                Compose and send messages to your contacts
              </p>
            </div>

            <div class="flex flex-row gap-8 items-start">
              <div class="flex-1 bg-slate-950 rounded-xl shadow-sm border border-slate-800 p-8 min-w-[400px] max-w-2xl">
                <form id="whatsapp-message-form" class="space-y-6">
    <script>
      const whatsappForm = document.getElementById("whatsapp-message-form");
      const activeSubmissions = [];
      const notify = (message) => {
        if (!message) return;
        if (typeof showNotification === "function") {
          showNotification(message);
          return;
        }

        let container = document.getElementById("notification-container");
        if (!container) {
          container = document.createElement("div");
          container.id = "notification-container";
          container.className = "fixed top-4 right-4 z-50 space-y-2";
          document.body.appendChild(container);
        }

        const notification = document.createElement("div");
        notification.className =
          "bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 fallback-notification";
        notification.textContent = message;
        container.appendChild(notification);

        setTimeout(() => {
          notification.style.opacity = "0";
          notification.style.transform = "translateX(100%)";
          setTimeout(() => {
            if (notification.parentNode === container) {
              container.removeChild(notification);
            }
          }, 300);
        }, 3000);
      };
      if (whatsappForm) {
        whatsappForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const recipients = document.getElementById("recipient-input")?.value || "";
          const message = document.getElementById("message-input")?.value || "";
          const media = document.getElementById("file-path-input")?.value || "";

          const recipientsList = recipients
            .split(",")
            .map((n) => n.trim())
            .filter(Boolean);
          const submission = createSubmissionRecord(recipientsList, message, media);

          const payload = {
            recipients,
            message,
            media
          };

          try {
            const res = await fetch("http://localhost:3000/send-messages", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (data && data.success) {
              const {
                recipients: responseRecipients = [],
                message: responseMessage = "",
                media: responseMedia = "",
              } = data;
              notify("Messages sent successfully!");
              submission.message = responseMessage;
              submission.media = responseMedia;
              finalizeSubmissionRecords(submission, responseRecipients);
            } else {
              notify(data.error || "Failed to send messages.");
              removeActiveSubmission(submission);
            }
          } catch (err) {
            notify("An error occurred while sending messages.");
            removeActiveSubmission(submission);
          }
        });
      }
    </script>
                  <div>
                    <label class="block text-sm font-medium text-slate-200 mb-2"
                      >Recipients (comma-separated)</label
                    >
                    <input
                      id="recipient-input"
                      type="text"
                      placeholder="e.g., +1234567890, +0987654321, +1122334455"
                      class="w-full px-4 py-3 border border-slate-700 bg-slate-900 text-slate-100 placeholder-slate-500 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none"
                    />
                    <p class="mt-1 text-sm text-slate-400">
                      Enter phone numbers with country code, separated by commas
                    </p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-200 mb-2"
                      >Import from CSV</label
                    >
                    <input
                      id="csv-file-input"
                      type="file"
                      accept=".csv,.xls,.xlsx,.xlsm,.xlsb,.ods,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel.sheet.macroEnabled.12,application/vnd.ms-excel.sheet.binary.macroEnabled.12,application/vnd.oasis.opendocument.spreadsheet"
                      class="hidden"
                    />
                    <div
                      id="csv-dropzone"
                      class="relative flex flex-col items-center justify-center gap-3 w-full px-6 py-6 border border-dashed border-slate-700 bg-slate-900 rounded-xl text-center transition hover:border-emerald-500 hover:bg-slate-900/80 cursor-pointer"
                    >
                      <div
                        class="flex h-12 w-12 items-center justify-center rounded-full bg-emerald-600/20 text-emerald-300"
                      >
                        <svg
                          class="w-6 h-6"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            d="M4 16l4-4m0 0l4 4m-4-4v12M20 12.41V6a2 2 0 00-2-2H6a2 2 0 00-2 2v6.41a2 2 0 00.586 1.414l6.999 6.999a2 2 0 002.828 0l7-7A2 2 0 0020 12.41z"
                          />
                        </svg>
                      </div>
                      <div>
                        <p class="text-sm font-medium text-slate-200">
                          Drag & drop an Excel file (.csv, .xls, .xlsx, .xlsm, .xlsb, .ods) or click to browse
                        </p>
                        <p class="text-xs text-slate-400 mt-1">
                          Numbers populate Recipients, messages populate Message automatically
                        </p>
                      </div>
                    </div>
                    <p id="csv-status" class="mt-2 text-xs text-slate-400"></p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-200 mb-2"
                      >Message</label
                    >
                    <textarea
                      id="message-input"
                      rows="5"
                      placeholder="Type your message here..."
                      class="w-full px-4 py-3 border border-slate-700 bg-slate-900 text-slate-100 placeholder-slate-500 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none"
                    ></textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-200 mb-2"
                      >File Path (optional)</label
                    >
                    <input
                      id="file-path-input"
                      type="text"
                      placeholder="e.g., /path/to/file.pdf or C:\Documents\file.jpg"
                      class="w-full px-4 py-3 border border-slate-700 bg-slate-900 text-slate-100 placeholder-slate-500 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none"
                    />
                    <p class="mt-1 text-sm text-slate-400">
                      Upload images, videos, documents, or audio files
                    </p>
                  </div>
                  <div class="flex flex-col md:flex-row justify-end gap-4">
                    <button
                      id="export-whatsapp-csv"
                      type="button"
                      class="bg-indigo-600 hover:bg-indigo-500 text-white font-medium px-8 py-3 rounded-lg transition flex items-center gap-2"
                    >
                      <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M12 4v16m8-8H4"
                        />
                      </svg>
                      Export CSV
                    </button>
                    <button
                      type="submit"
                      class="bg-emerald-600 hover:bg-emerald-500 text-white font-medium px-8 py-3 rounded-lg transition flex items-center gap-2"
                    >
                      <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M5 13l4 4L19 7"
                        />
                      </svg>
                      Send Messages
                    </button>
                  </div>
                </form>
              </div>
              <aside
                class="w-[520px] bg-gradient-to-br from-slate-900 to-slate-950 border-2 border-indigo-700 rounded-2xl p-8 text-slate-200 text-base flex-shrink-0 shadow-2xl ml-0"
              >
              <h3 class="font-semibold text-lg mb-2 text-indigo-300">
                Excel Import Format &amp; Requirements
              </h3>
              <ul class="list-disc pl-5 mb-3">
                <li>
                  The Excel file must have <b>three columns</b> with headings:
                  <b>Number</b>, <b>Message</b>, <b>Media</b>.
                </li>
                <li>
                  <b>Order matters:</b> First column = Number, second = Message,
                  third = Media file path.
                </li>
                <li>Each row represents a WhatsApp message to send.</li>
              </ul>
              <h4 class="font-semibold text-slate-100 mb-1">
                Required Conditions:
              </h4>
              <ul class="list-disc pl-5 mb-3">
                <li>
                  If any field is missing for a row, leave that column empty
                  (e.g., <b>,,</b> for all empty).
                </li>
                <li>
                  <b>Number</b> is required to send a message; if missing, that
                  row will be ignored.
                </li>
                <li>
                  <b>Message</b> is required for sending text; if missing, only
                  media will be sent (if provided).
                </li>
                <li>
                  <b>Media</b> is optional; leave empty if not sending a file.
                </li>
                <li>
                  All columns must be present in the file, even if some are
                  empty.
                </li>
                <li>
                  File must include the header row:
                  <b>Number,Message,Media</b>
                </li>
              </ul>
                <div class="mt-6">
                  <div class="font-semibold text-slate-300 mb-2">Example:</div>
                  <div class="overflow-x-auto">
                    <table class="min-w-full text-left text-slate-200 text-sm border border-slate-700 rounded-lg bg-slate-800 shadow">
                      <thead>
                        <tr class="bg-slate-900">
                          <th class="px-4 py-2 border-b border-slate-700 font-bold">Number</th>
                          <th class="px-4 py-2 border-b border-slate-700 font-bold">Message</th>
                          <th class="px-4 py-2 border-b border-slate-700 font-bold">Media</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td class="px-4 py-2 border-b border-slate-700">+1234567890</td>
                          <td class="px-4 py-2 border-b border-slate-700">Hello there!</td>
                          <td class="px-4 py-2 border-b border-slate-700">C:\files\image.jpg</td>
                        </tr>
                        <tr>
                          <td class="px-4 py-2 border-b border-slate-700">+1987654321</td>
                          <td class="px-4 py-2 border-b border-slate-700">How are you?</td>
                          <td class="px-4 py-2 border-b border-slate-700"></td>
                        </tr>
                        <tr>
                          <td class="px-4 py-2">+1122334455</td>
                          <td class="px-4 py-2"></td>
                          <td class="px-4 py-2">C:\files\audio.mp3</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                
              </div>
            </aside>
          </section>

          <section id="section-ai" class="tab-section hidden">
            <div class="mb-6">
              <h2 class="text-2xl font-bold text-slate-100 mb-2">
                AI Content Generation
              </h2>
              <p class="text-slate-400">
                Use AI to generate content, messages, or business names
              </p>
            </div>

            <div
              class="bg-slate-950 rounded-xl shadow-sm border border-slate-800 p-8 max-w-3xl"
            >
              <form class="space-y-6">
                <div>
                  <label class="block text-sm font-medium text-slate-200 mb-2"
                    >Prompt</label
                  >
                  <textarea
                    id="ai-prompt-input"
                    rows="3"
                    placeholder="Enter your prompt here..."
                    class="w-full px-4 py-3 border border-slate-700 bg-slate-900 text-slate-100 placeholder-slate-500 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                  ></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-slate-200 mb-2"
                      >Language</label
                    >
                    <select
                      id="ai-lang-select"
                      class="w-full px-4 py-3 border border-slate-700 bg-slate-900 text-slate-100 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                    >
                      <option value="" disabled selected>Language</option>
                      <option value="English">English</option>
                      <option value="Spanish">Spanish</option>
                      <option value="French">French</option>
                      <option value="Finnish">Finnish</option>
                      <option value="German">German</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-200 mb-2"
                      >Word Length</label
                    >
                    <select
                      id="ai-wordlen-select"
                      class="w-full px-4 py-3 border border-slate-700 bg-slate-900 text-slate-100 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                    >
                      <option value="" disabled selected>Word Length</option>
                      <option value="short">Short (50-100 words)</option>
                      <option value="long">Long (200-400 words)</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-slate-200 mb-2"
                      >Tone</label
                    >
                    <select
                      id="ai-tone-select"
                      class="w-full px-4 py-3 border border-slate-700 bg-slate-900 text-slate-100 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none"
                    >
                      <option value="" disabled selected>Tone</option>
                      <option value="Casual">Casual</option>
                      <option value="Professional">Professional</option>
                      <option value="Friendly">Friendly</option>
                      <option value="Urgent">Urgent</option>
                    </select>
                  </div>
                </div>
                <button
                  type="submit"
                  class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-medium px-8 py-4 rounded-lg transition shadow-lg"
                >
                  Generate Content
                </button>
              </form>
            </div>
          </section>
        </div>
      </main>
    </div>

    <script>
      const exportBtn = document.getElementById("export-whatsapp-csv");
      if (exportBtn) {
        exportBtn.addEventListener("click", () => {
          const recipients =
            document.getElementById("recipient-input")?.value || "";
          const message = document.getElementById("message-input")?.value || "";
          const media = document.getElementById("file-path-input")?.value || "";

          const numbers = recipients
            .split(",")
            .map((n) => n.trim())
            .filter(Boolean);
          const rows = numbers.length
            ? numbers.map((num) => [num, message, media])
            : [["", message, media]];

          let csv = "Number,Message,Media\n";
          csv += rows
            .map((row) =>
              row
                .map((cell) => '"' + (cell || "").replace(/"/g, '""') + '"')
                .join(",")
            )
            .join("\n");

          const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "whatsapp_messages.csv";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });
      }
      const tabBtns = document.querySelectorAll(".tab-btn");
      const sections = {
        dashboard: document.getElementById("section-dashboard"),
        whatsapp: document.getElementById("section-whatsapp"),
        ai: document.getElementById("section-ai"),
      };

      function setActiveTab(tab) {
        Object.entries(sections).forEach(([key, el]) => {
          if (el) el.classList.toggle("hidden", key !== tab);
        });

        tabBtns.forEach((btn) => {
          if (btn.dataset.tab === tab) {
            btn.classList.remove(
              "bg-transparent",
              "text-slate-300",
              "hover:bg-slate-900",
              "border-transparent"
            );
            btn.classList.add(
              "bg-emerald-700",
              "text-emerald-100",
              "border-emerald-500"
            );
          } else {
            btn.classList.add(
              "bg-transparent",
              "text-slate-300",
              "hover:bg-slate-900",
              "border-transparent"
            );
            btn.classList.remove(
              "bg-emerald-700",
              "text-emerald-100",
              "border-emerald-500"
            );
          }
        });
      }

      tabBtns.forEach((btn) => {
        btn.addEventListener("click", () => setActiveTab(btn.dataset.tab));
      });

      setActiveTab("dashboard");

      const csvDropzone = document.getElementById("csv-dropzone");
      const csvFileInput = document.getElementById("csv-file-input");
      const csvStatus = document.getElementById("csv-status");
      const recipientInput = document.getElementById("recipient-input");
      const messageInput = document.getElementById("message-input");
      const filePathInput = document.getElementById("file-path-input");

      const dropActiveClasses = ["border-emerald-500", "bg-slate-900/60"];

      function setCsvStatus(message, type = "info") {
        if (!csvStatus) return;
        csvStatus.textContent = message;
        csvStatus.classList.remove(
          "text-slate-400",
          "text-emerald-400",
          "text-rose-400"
        );
        const colorClass =
          type === "success"
            ? "text-emerald-400"
            : type === "error"
            ? "text-rose-400"
            : "text-slate-400";
        csvStatus.classList.add(colorClass);
      }

      function toggleDropzoneHighlight(active) {
        if (!csvDropzone) return;
        dropActiveClasses.forEach((cls) => {
          csvDropzone.classList.toggle(cls, active);
        });
      }

      function normalizeNumber(raw) {
        if (!raw) return "";
        const trimmed = raw.trim();
        const hasPlus = trimmed.startsWith("+");
        const digits = trimmed.replace(/[^0-9]/g, "");
        if (!digits) return "";
        return `${hasPlus ? "+" : ""}${digits}`;
      }

      function normalizeRecipientValue(value) {
        if (!value) return "";
        const normalized = normalizeNumber(value);
        return normalized || value.trim();
      }

      function getFormattedTimestamp(date = new Date()) {
        const pad = (num) => String(num).padStart(2, "0");
        return (
          date.getFullYear() +
          "-" +
          pad(date.getMonth() + 1) +
          "-" +
          pad(date.getDate()) +
          " " +
          pad(date.getHours()) +
          ":" +
          pad(date.getMinutes()) +
          ":" +
          pad(date.getSeconds())
        );
      }

      function createSubmissionRecord(recipientsList, message, media) {
        const normalizedRecipients = recipientsList.map(normalizeRecipientValue);
        const submission = {
          id:
            Date.now().toString(36) + Math.random().toString(36).slice(2, 8),
          recipients: recipientsList,
          normalizedRecipients,
          message,
          media,
          completedRecipients: new Set(),
          failedRecipients: new Set(),
        };
        activeSubmissions.push(submission);
        return submission;
      }

      function removeActiveSubmission(submission) {
        const index = activeSubmissions.indexOf(submission);
        if (index !== -1) {
          activeSubmissions.splice(index, 1);
        }
      }

      function findSubmissionByRecipient(recipient) {
        const normalizedRecipient = normalizeRecipientValue(recipient);
        for (const submission of activeSubmissions) {
          const index = submission.normalizedRecipients.findIndex(
            (candidate, idx) =>
              candidate === normalizedRecipient ||
              submission.recipients[idx] === recipient.trim()
          );
          if (index !== -1) {
            return { submission, index, normalizedRecipient };
          }
        }
        return null;
      }

      function addDashboardRecordFromSubmission(
        submission,
        recipientIndex,
        deliveredAt
      ) {
        if (!submission || recipientIndex < 0) return false;
        const normalized = submission.normalizedRecipients[recipientIndex];
        if (submission.completedRecipients.has(normalized)) {
          return false;
        }

        const entryDeliveredAt = deliveredAt || getFormattedTimestamp();
        const nextId = dashboardData.length
          ? Math.max(...dashboardData.map((d) => d.id)) + 1
          : 1;

        dashboardData.push({
          id: nextId,
          sender: submission.recipients.join(", "),
          message: submission.message,
          recipient: submission.recipients[recipientIndex],
          media: submission.media,
          deliveredAt: entryDeliveredAt,
        });

        submission.completedRecipients.add(normalized);
        renderDashboardTable(dashboardData);
        localStorage.setItem("dashboardData", JSON.stringify(dashboardData));
        return true;
      }

      function markSubmissionRecipientFailed(submission, recipientIndex) {
        if (!submission || recipientIndex < 0) return;
        const normalized = submission.normalizedRecipients[recipientIndex];
        submission.failedRecipients.add(normalized);
        submission.completedRecipients.add(normalized);
        maybeFinalizeSubmission(submission);
      }

      function finalizeSubmissionRecords(submission, recipientsOverride) {
        if (!submission) return;
        const recipientsToProcess =
          Array.isArray(recipientsOverride) && recipientsOverride.length
            ? recipientsOverride
            : submission.recipients;

        recipientsToProcess.forEach((recipient) => {
          const match = findSubmissionByRecipient(recipient);
          if (match && match.submission === submission) {
            addDashboardRecordFromSubmission(submission, match.index);
          }
        });

        maybeFinalizeSubmission(submission);
      }

      function maybeFinalizeSubmission(submission) {
        if (!submission) return;
        if (submission.completedRecipients.size >= submission.recipients.length) {
          removeActiveSubmission(submission);
        }
      }

      function isNumberLike(value) {
        if (!value) return false;
        const normalized = normalizeNumber(value);
        return Boolean(normalized) && /^\+?\d+$/.test(normalized);
      }

      function stripHeader(rows) {
        if (!rows.length) return rows;
        const headerKeywords = [
          "number",
          "numbers",
          "phone",
          "message",
          "text",
        ];
        const lowerRow = rows[0].map((cell) => cell.toLowerCase());
        const hasHeaderKeyword = lowerRow.some((cell) =>
          headerKeywords.some((keyword) => cell.includes(keyword))
        );
        return hasHeaderKeyword ? rows.slice(1) : rows;
      }

      function parseCSV(content) {
        const rows = [];
        let current = "";
        let row = [];
        let inQuotes = false;
        for (let i = 0; i < content.length; i += 1) {
          const char = content[i];
          if (char === '"') {
            if (inQuotes && content[i + 1] === '"') {
              current += '"';
              i += 1;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === "," && !inQuotes) {
            row.push(current);
            current = "";
          } else if ((char === "\n" || char === "\r") && !inQuotes) {
            if (char === "\r" && content[i + 1] === "\n") {
              i += 1;
            }
            row.push(current);
            rows.push(row);
            row = [];
            current = "";
          } else {
            current += char;
          }
        }
        if (inQuotes) {
          row.push(current);
          rows.push(row);
        } else if (current.length || row.length) {
          row.push(current);
          rows.push(row);
        }
        return rows.map((r) => r.map((cell) => cell.trim()));
      }

      function processCSVText(text) {
        if (!text) {
          setCsvStatus("Uploaded file was empty.", "error");
          return;
        }

        const sanitizedText = text.replace(/^\ufeff/, "");

        let rows = parseCSV(sanitizedText);
        rows = rows.filter((row) => row.some((cell) => cell.length));
        rows = stripHeader(rows);

        if (!rows.length) {
          setCsvStatus("No usable rows found in the CSV.", "error");
          return;
        }

        const columnCount = rows.reduce(
          (max, row) => Math.max(max, row.length),
          0
        );

        const numbers = [];
        const messages = [];
        const mediaPaths = [];

        function formatParts(parts) {
          if (!parts.length) return "";
          if (parts.length === 1) return parts[0];
          if (parts.length === 2) return `${parts[0]} and ${parts[1]}`;
          return `${parts.slice(0, -1).join(", ")}, and ${
            parts[parts.length - 1]
          }`;
        }

        if (columnCount <= 1) {
          const values = rows.map((row) => row[0]).filter(Boolean);
          if (!values.length) {
            setCsvStatus("No data found in the CSV.", "error");
            return;
          }
          const allNumbers =
            values.length && values.every((val) => isNumberLike(val));
          if (allNumbers) {
            values.forEach((val) => {
              const normalized = normalizeNumber(val);
              if (normalized) numbers.push(normalized);
            });
            setCsvStatus(
              `Imported ${numbers.length} phone number(s).`,
              "success"
            );
          } else {
            const messageValue = values[0] ? values[0].trim() : "";
            if (!messageValue) {
              setCsvStatus(
                "Could not find message content in the CSV.",
                "error"
              );
              return;
            }
            messages.push(messageValue);
            setCsvStatus("Imported message content from CSV.", "success");
          }
        } else {
          rows.forEach((row) => {
            const numberCandidate = row[0];
            const messageCandidate = row[1];
            const mediaCandidate = row[2];
            if (numberCandidate && isNumberLike(numberCandidate)) {
              const normalized = normalizeNumber(numberCandidate);
              if (normalized) numbers.push(normalized);
            }
            if (
              messageCandidate &&
              messageCandidate.length &&
              !messages.length
            ) {
              messages.push(messageCandidate.trim());
            }
            if (
              mediaCandidate &&
              mediaCandidate.trim().length &&
              !mediaPaths.length
            ) {
              mediaPaths.push(mediaCandidate.trim());
            }
          });

          if (!numbers.length && !messages.length && !mediaPaths.length) {
            setCsvStatus(
              "CSV rows must contain phone numbers, messages, or media file paths.",
              "error"
            );
            return;
          }

          const numberCount = new Set(numbers).size;

          const statusParts = [];
          if (numberCount) statusParts.push(`${numberCount} phone number(s)`);
          if (messages.length) statusParts.push("message content");
          if (mediaPaths.length)
            statusParts.push(
              mediaPaths.length > 1 ? "media file paths" : "media file path"
            );

          setCsvStatus(`Imported ${formatParts(statusParts)}.`, "success");
        }

        if (numbers.length && recipientInput) {
          const uniqueNumbers = [...new Set(numbers)];
          recipientInput.value = uniqueNumbers.join(", ");
        }

        if (messages.length && messageInput) {
          messageInput.value = messages[0];
        }

        if (mediaPaths.length && filePathInput) {
          filePathInput.value = mediaPaths[0];
        }
      }

      function handleCsvFiles(fileList) {
        if (!fileList || !fileList.length) {
          setCsvStatus("No file selected.", "error");
          return;
        }
        const file = fileList[0];
        const fileName = file.name.toLowerCase();
        const isExcel = /\.(csv|xlsx|xls|xlsm|xlsb|ods)$/.test(fileName);
        if (!isExcel) {
          setCsvStatus("Please upload a valid Excel file (.csv, .xls, .xlsx, .xlsm, .xlsb, .ods).", "error");
          return;
        }
        setCsvStatus("Processing file...", "info");
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            let data = event.target.result;
            if (fileName.endsWith('.csv')) {
              processCSVText(typeof data === "string" ? data : "");
            } else {
              // Parse Excel file using SheetJS
              let workbook = XLSX.read(data, { type: 'binary' });
              let firstSheet = workbook.SheetNames[0];
              let sheet = workbook.Sheets[firstSheet];
              let json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
              // Convert to CSV-like text for existing logic
              let csvText = json.map(row => row.join(',')).join('\n');
              processCSVText(csvText);
            }
          } catch (error) {
            console.error("Error processing file:", error);
            setCsvStatus("Failed to process file.", "error");
          }
        };
        reader.onerror = () => {
          setCsvStatus("Could not read the file.", "error");
        };
        if (fileName.endsWith('.csv')) {
          reader.readAsText(file);
        } else {
          reader.readAsBinaryString(file);
        }
        if (csvFileInput) {
          csvFileInput.value = "";
        }
      }

      if (csvDropzone && csvFileInput) {
        csvDropzone.addEventListener("click", () => csvFileInput.click());
        csvDropzone.addEventListener("dragenter", (event) => {
          event.preventDefault();
          toggleDropzoneHighlight(true);
        });
        csvDropzone.addEventListener("dragover", (event) => {
          event.preventDefault();
          toggleDropzoneHighlight(true);
        });
        csvDropzone.addEventListener("dragleave", (event) => {
          event.preventDefault();
          toggleDropzoneHighlight(false);
        });
        csvDropzone.addEventListener("drop", (event) => {
          event.preventDefault();
          toggleDropzoneHighlight(false);
          handleCsvFiles(event.dataTransfer.files);
        });
        csvFileInput.addEventListener("change", (event) => {
          const target = event.target;
          handleCsvFiles(target.files);
        });
      }

      let dashboardData = [];
      const storedDashboard = localStorage.getItem("dashboardData");
      if (storedDashboard) {
        try {
          dashboardData = JSON.parse(storedDashboard);
        } catch (e) {
          dashboardData = [];
        }
      }

      function renderDashboardTable(data) {
        const tbody = document.getElementById("dashboard-table-body");
        tbody.innerHTML = data
          .map((row) => {
            let mediaCell = '';
            if (row.media) {
              mediaCell = `<span class="text-xs text-slate-400">${row.media}</span>`;
            }
            let deliveredAtCell = row.deliveredAt ? `<span class="text-xs text-slate-400">${row.deliveredAt}</span>` : '';
            return `
  <tr class="hover:bg-slate-900">
    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-100">${row.id}</td>
    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-100">${row.sender}</td>
    <td class="px-4 py-3 text-sm text-slate-200">${row.message}</td>
    <td class="px-4 py-3 whitespace-nowrap text-sm text-slate-100">${row.recipient}</td>
    <td class="px-4 py-3 text-sm text-slate-200">${mediaCell}</td>
    <td class="px-4 py-3 text-sm text-slate-200">${deliveredAtCell}</td>
  </tr>
`;
          })
          .join("");
      }


      function isAnyFilterApplied() {
        return (
          document.getElementById("filter-sender").value.trim() !== '' ||
          document.getElementById("filter-message").value.trim() !== '' ||
          document.getElementById("filter-media").value.trim() !== '' ||
          document.getElementById("filter-delivered-at").value !== ''
        );
      }

      function updateClearFilterBtnState() {
        const clearBtn = document.getElementById("clear-filter-btn");
        if (!clearBtn) return;
        if (isAnyFilterApplied()) {
          clearBtn.disabled = false;
          clearBtn.classList.remove("opacity-50", "cursor-not-allowed");
        } else {
          clearBtn.disabled = true;
          clearBtn.classList.add("opacity-50", "cursor-not-allowed");
        }
      }

      function filterDashboardTable() {
        const sender = document.getElementById("filter-sender").value.trim().toLowerCase();
        const message = document.getElementById("filter-message").value.trim().toLowerCase();
        const media = document.getElementById("filter-media").value.trim().toLowerCase();
        const deliveredAt = document.getElementById("filter-delivered-at").value;

        const filtered = dashboardData.filter((row) => {
          const senderMatch = !sender || (row.sender && row.sender.toLowerCase().includes(sender));
          const messageMatch = !message || (row.message && row.message.toLowerCase().includes(message));
          const mediaMatch = !media || (row.media && row.media.toLowerCase().includes(media));
          let deliveredAtMatch = true;
          if (deliveredAt) {
            if (row.deliveredAt) {
              const rowDate = row.deliveredAt.split(' ')[0];
              deliveredAtMatch = rowDate === deliveredAt;
            } else {
              deliveredAtMatch = false;
            }
          }
          return senderMatch && messageMatch && mediaMatch && deliveredAtMatch;
        });
        renderDashboardTable(filtered);
        updateClearFilterBtnState();
      }

      function clearDashboardFilters() {
        document.getElementById("filter-sender").value = '';
        document.getElementById("filter-message").value = '';
        document.getElementById("filter-media").value = '';
        document.getElementById("filter-delivered-at").value = '';
        renderDashboardTable(dashboardData);
        updateClearFilterBtnState();
      }

      document.getElementById("filter-btn").addEventListener("click", filterDashboardTable);
      document.getElementById("clear-filter-btn").addEventListener("click", clearDashboardFilters);

      ["filter-sender", "filter-message", "filter-media", "filter-delivered-at"].forEach(id => {
        document.getElementById(id).addEventListener("input", updateClearFilterBtnState);
      });

      renderDashboardTable(dashboardData);
      updateClearFilterBtnState();
  </script>

    <script>
      const connectBtn = document.getElementById("connectBtn");
      connectBtn.addEventListener("click", () => {
        fetch("http://localhost:3000/connect-whatsapp", {
          method: "GET",
          contents: "application/json",
        })
          .then((res) => res.json())
          .then((data) => {
            if (data && data.success === true) {
              connectBtn.innerText = "Connected";
              connectBtn.disabled = true;
              notify("WhatsApp connected successfully!");
            } else {
              notify("Failed to connect to WhatsApp.");
            }
          })
          .catch((error) => {
            console.error("Error connecting to WhatsApp:", error);
            notify("An error occurred while connecting to WhatsApp.");
          });
      });

      const aiForm = document.querySelector("#section-ai form");
      const aiPromptInput = document.getElementById("ai-prompt-input");
      const aiLangSelect = document.getElementById("ai-lang-select");
      const aiWordLenSelect = document.getElementById("ai-wordlen-select");
      const aiToneSelect = document.getElementById("ai-tone-select");

      let aiResponseDiv = document.getElementById("ai-response");
      if (!aiResponseDiv) {
        aiResponseDiv = document.createElement("div");
        aiResponseDiv.id = "ai-response";
        aiResponseDiv.className =
          "mt-6 bg-slate-900 border border-slate-700 rounded-lg p-6 text-slate-200";
        aiForm.parentNode.appendChild(aiResponseDiv);
      }


      let downloadBtn = document.getElementById("ai-download-btn");
      if (!downloadBtn) {
        downloadBtn = document.createElement("button");
        downloadBtn.id = "ai-download-btn";
        downloadBtn.type = "button";
        downloadBtn.className =
          "mt-4 bg-indigo-600 hover:bg-indigo-500 text-white font-medium px-6 py-2 rounded-lg transition hidden mr-3";
        downloadBtn.textContent = "Download as CSV";
        aiResponseDiv.appendChild(downloadBtn);
      }

      let copyBtn = document.getElementById("ai-copy-btn");
      if (!copyBtn) {
        copyBtn = document.createElement("button");
        copyBtn.id = "ai-copy-btn";
        copyBtn.type = "button";
        copyBtn.className =
          "mt-4 bg-emerald-600 hover:bg-emerald-500 text-white font-medium px-6 py-2 rounded-lg transition hidden";
        copyBtn.textContent = "Copy to Clipboard";
        aiResponseDiv.appendChild(copyBtn);
      }

      let lastAiMessage = "";


      aiForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        aiResponseDiv.innerHTML =
          '<span class="text-slate-400">Generating content...</span>';
        downloadBtn.classList.add("hidden");
        copyBtn.classList.add("hidden");
        lastAiMessage = "";
        const prompt = aiPromptInput.value.trim();
        const language = aiLangSelect.value;
        const wordLength = aiWordLenSelect.value;
        const tone = aiToneSelect.value;

        if (!prompt || !language || !wordLength || !tone) {
          aiResponseDiv.innerHTML =
            '<span class="text-rose-400">Please fill in all fields.</span>';
          return;
        }

        try {
          const res = await fetch("http://localhost:3000/generate-message", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt, language, wordLength, tone }),
          });
          const data = await res.json();
          if (data && data.message) {
            lastAiMessage = data.message;
            aiResponseDiv.innerHTML = `<div class='whitespace-pre-line mb-4'>${data.message.replace(
              /\n/g,
              "<br>"
            )}</div>`;
            aiResponseDiv.appendChild(downloadBtn);
            aiResponseDiv.appendChild(copyBtn);
            downloadBtn.classList.remove("hidden");
            copyBtn.classList.remove("hidden");
          } else {
            aiResponseDiv.innerHTML = `<span class='text-rose-400'>${
              data.error || "No message returned."
            }</span>`;
          }
        } catch (err) {
          aiResponseDiv.innerHTML = `<span class='text-rose-400'>Failed to generate content.</span>`;
        }
      });


      downloadBtn.addEventListener("click", () => {
        if (!lastAiMessage) return;
        const csvContent =
          "data:text/csv;charset=utf-8," +
          encodeURIComponent(
            'Message\n"' +
              lastAiMessage.replace(/"/g, '""').replace(/\n/g, "\n") +
              '"'
          );
        const link = document.createElement("a");
        link.setAttribute("href", csvContent);
        link.setAttribute("download", "ai_message.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });

      copyBtn.addEventListener("click", async () => {
        if (!lastAiMessage) return;
        try {
          await navigator.clipboard.writeText(lastAiMessage);
          copyBtn.textContent = "Copied!";
          setTimeout(() => {
            copyBtn.textContent = "Copy to Clipboard";
          }, 1200);
        } catch (err) {
          copyBtn.textContent = "Failed to Copy";
          setTimeout(() => {
            copyBtn.textContent = "Copy to Clipboard";
          }, 1200);
        }
      });
    </script>
    <script>
      let socket = null;
      let reconnectInterval = null;

      function connectWebSocket() {
        try {
          socket = new WebSocket("ws://localhost:8080");

          socket.onopen = () => {
            console.log("WebSocket connected");
            if (reconnectInterval) {
              clearInterval(reconnectInterval);
              reconnectInterval = null;
            }
          };

          socket.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              if (data && data.status) {
                showNotification(data.status);
                handleStatusUpdate(data.status);
              }
            } catch (e) {
              console.error("Error parsing WebSocket message:", e);
            }
          };

          socket.onerror = (error) => {
            console.error("WebSocket error:", error);
          };

          socket.onclose = () => {
            console.log("WebSocket disconnected");
            if (!reconnectInterval) {
              reconnectInterval = setInterval(() => {
                console.log("Attempting to reconnect WebSocket...");
                connectWebSocket();
              }, 3000);
            }
          };
        } catch (e) {
          console.error("Failed to connect WebSocket:", e);
        }
      }

      let notificationContainer = document.getElementById("notification-container");
      if (!notificationContainer) {
        notificationContainer = document.createElement("div");
        notificationContainer.id = "notification-container";
        document.body.appendChild(notificationContainer);
      }
      notificationContainer.className = "fixed top-4 right-4 z-50 space-y-2";

      function showNotification(message) {
        if (!message) return;
        const notification = document.createElement("div");
        notification.className =
          "bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-slide-in";
        notification.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
          </svg>
          <span>${message}</span>
        `;

        notificationContainer.appendChild(notification);

        setTimeout(() => {
          notification.style.opacity = "0";
          notification.style.transform = "translateX(100%)";
          setTimeout(() => {
            if (notification.parentNode === notificationContainer) {
              notificationContainer.removeChild(notification);
            }
          }, 300);
        }, 3000);
      }

      function handleStatusUpdate(status) {
        if (!status) return;

        const sentMatch = status.match(/^Message\s+\d+\/\d+\s+sent to\s+(.+)$/i);
        if (sentMatch) {
          const recipient = sentMatch[1].trim();
          const match = findSubmissionByRecipient(recipient);
          if (match) {
            addDashboardRecordFromSubmission(match.submission, match.index);
            maybeFinalizeSubmission(match.submission);
          }
          return;
        }

        const failedMatch = status.match(/^Failed to send to\s+(.+)$/i);
        if (failedMatch) {
          const recipient = failedMatch[1].trim();
          const match = findSubmissionByRecipient(recipient);
          if (match) {
            markSubmissionRecipientFailed(match.submission, match.index);
          }
          return;
        }

        if (/^âœ… Completed!/.test(status)) {
          activeSubmissions.slice().forEach((submission) => {
            finalizeSubmissionRecords(submission);
          });
        }
      }

      connectWebSocket();

      const style = document.createElement("style");
      style.textContent = `
        @keyframes slide-in {
          from {
            opacity: 0;
            transform: translateX(100%);
          }
          to {
            opacity: 1;
            transform: translateX(0);
          }
        }
        .animate-slide-in {
          animation: slide-in 0.3s ease-out;
        }
        #notification-container > div {
          transition: opacity 0.3s, transform 0.3s;
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
